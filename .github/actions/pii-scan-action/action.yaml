name: 'PII Check'
description: 'Scans commits for personally identifiable information (PII) and sensitive data'

inputs:
  github_token:
    description: 'GitHub token for creating issues and labels'
    required: true
    default: '${{ github.token }}'
  fail_on_detection:
    description: 'Whether to fail the workflow if sensitive information is detected'
    required: false
    default: 'true'

runs:
  using: "composite"
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: List files in the commit
      id: list_files
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          git fetch origin "$BASE_SHA" --depth=1
          git diff --name-status "$BASE_SHA" HEAD > files_changed.txt
        else
          if [[ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]]; then
            BASE_SHA="${{ github.event.before }}"
          else
            BASE_SHA="HEAD^"
          fi
          git diff --name-status "$BASE_SHA" HEAD > files_changed.txt || echo "A all_files" > files_changed.txt
        fi
        [ ! -s files_changed.txt ] && git ls-files | awk '{print "A\t" $0}' > files_changed.txt

    - name: Scan for sensitive information
      id: scan_sensitive_info
      shell: bash
      run: |
        # 1. DEFINITIONS
        declare -A regex_patterns=(
          ["PAN"]='\b[A-Z]{5}[0-9]{4}[A-Z]\b'
          ["Aadhaar"]='\b[2-9][0-9]{3}\s[0-9]{4}\s[0-9]{4}\b'
          ["Credit/Debit Card"]='\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|6(?:011|5[0-9]{2})[0-9]{12}|(?:2131|1800|35\d{3})\d{11})\b'
          ["Phone Number"]='\b(?:\+91|0|91)?[6-9][0-9]{9}\b'
          ["Email"]='\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b'
          ["API Key"]='(api_key|apikey|api-key).{0,20}(["'\''])[0-9a-zA-Z_-]{16,}\2'
          ["Secret Token"]='(secret|token|access_token).{0,20}(["'\''])[0-9a-zA-Z_-]{16,}\2'
        )
        exclude_extensions=("yml" "yaml" "env" "mod" "sum" "svg" "lock" "md" "png" "jpg" "jpeg" "json")
        exclude_files=("package.json" "package-lock.json" "yarn.lock" "go.sum" "go.mod" "example.env")
        exclude_dirs=("tests" "test" "__tests__" "__mocks__" "mocks" "fixtures" "docs" "node_modules" "dist" "build")

        # 2. SCAN LOGIC
        found_sensitive_info=false
        total_violations=0
        touch violations_report.txt

        while IFS= read -r line; do
          status=$(echo "$line" | awk '{print $1}')
          file=$(echo "$line" | awk '{$1=""; print $0}' | sed 's/^[ \t]*//')
          [[ "$status" == R* ]] && file=$(echo "$file" | awk '{print $2}')
          [[ "$status" == "D" || ! -f "$file" ]] && continue
          
          # Simplified skip check for clarity
          SKIP=false
          for ext in "${exclude_extensions[@]}"; do [[ "$file" == *."$ext" ]] && SKIP=true; done
          [[ "$file" == *"test-pii-data"* ]] && SKIP=false # Force test files

          if [[ "$SKIP" == "false" ]]; then
            for info_type in "${!regex_patterns[@]}"; do
              pattern="${regex_patterns[$info_type]}"
              match=$(grep -nP "$pattern" "$file" | head -n 5)
              if [[ -n "$match" ]]; then
                found_sensitive_info=true
                while IFS= read -r line_match; do
                  line_num=$(echo "$line_match" | cut -d: -f1)
                  content=$(echo "$line_match" | cut -d: -f2-)
                  echo "::error file=$file,line=$line_num,title=$info_type Detected::PII Found in $file"
                  echo "- **$info_type**: \`$file:$line_num\`" >> violations_report.txt
                  ((total_violations++))
                done <<< "$match"
              fi
            done
          fi
        done < files_changed.txt

        echo "sensitive_info=$found_sensitive_info" >> $GITHUB_OUTPUT
        echo "violation_count=$total_violations" >> $GITHUB_OUTPUT

    - name: Write Summary Report
      if: always()
      shell: bash
      run: |
        echo "## ðŸ” Sensitive Data Scan Summary" >> $GITHUB_STEP_SUMMARY
        VIOLATIONS="${{ steps.scan_sensitive_info.outputs.violation_count }}"
        VIOLATIONS=${VIOLATIONS:-0}
        
        if [[ "$VIOLATIONS" -gt 0 ]]; then
            echo "### ðŸ›‘ Found $VIOLATIONS PII violations" >> $GITHUB_STEP_SUMMARY
            echo "Review the following findings and scrub history immediately:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            [ -f violations_report.txt ] && cat violations_report.txt >> $GITHUB_STEP_SUMMARY
        else
            echo "âœ… **No sensitive PII or secrets detected.**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸš¨ Report PII Incident
      if: steps.scan_sensitive_info.outputs.sensitive_info == 'true'
      uses: Caladrius-Health-AI-Studio/github-actions/.github/actions/report-security-issue@main
      with:
        scan_name: "PII Detection"
        severity: "CRITICAL"
        finding_summary: "${{ steps.scan_sensitive_info.outputs.violation_count }} PII instances detected."
        details_file_path: "violations_report.txt"
        remediation_steps: |
          1. Revoke any exposed API keys.
          2. Use `git filter-repo` to scrub the leaked data from history.

    - name: Fail Workflow Gate
      if: steps.scan_sensitive_info.outputs.sensitive_info == 'true' && inputs.fail_on_detection == 'true'
      shell: bash
      run: |
        echo "::error::PII Gate Failed. Blocking merge."
        exit 1
